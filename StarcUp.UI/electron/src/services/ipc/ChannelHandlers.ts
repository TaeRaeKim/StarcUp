import { IIPCService } from './interfaces'
import { ICoreCommunicationService } from '../core'
import { IAuthService } from '../auth'
import { IDataStorageService } from '../storage'
import { IWindowManager, IShortcutManager } from '../window'
import { IOverlayAutoManager } from '../overlay'

export class ChannelHandlers {
  private ipcService: IIPCService
  private coreService: ICoreCommunicationService
  private authService: IAuthService
  private dataService: IDataStorageService
  private windowManager: IWindowManager
  private shortcutManager: IShortcutManager
  private overlayAutoManager: IOverlayAutoManager

  constructor(
    ipcService: IIPCService,
    coreService: ICoreCommunicationService,
    authService: IAuthService,
    dataService: IDataStorageService,
    windowManager: IWindowManager,
    shortcutManager: IShortcutManager,
    overlayAutoManager: IOverlayAutoManager
  ) {
    this.ipcService = ipcService
    this.coreService = coreService
    this.authService = authService
    this.dataService = dataService
    this.windowManager = windowManager
    this.shortcutManager = shortcutManager
    this.overlayAutoManager = overlayAutoManager
  }

  setupAllHandlers(): void {    
    this.setupCoreHandlers()
    this.setupAuthHandlers()
    this.setupDataHandlers()
    this.setupWindowHandlers()
    this.setupShortcutHandlers()
    console.log('‚úÖ Î™®Îì† IPC Ìï∏Îì§Îü¨ ÏÑ§Ï†ï ÏôÑÎ£å')
  }

  private setupCoreHandlers(): void {
    // Core Í¥ÄÎ†® Ìï∏Îì§Îü¨
    this.ipcService.registerHandler('core:status', async () => ({
      connected: this.coreService.isConnected
    }))

    this.ipcService.registerHandler('core:start-detection', async () => {
      const result = await this.coreService.startGameDetection()
      // Í≤åÏûÑ Í∞êÏßÄ ÏãúÏûë Ïãú ÏûêÎèô overlay Í¥ÄÎ¶¨ ÌôúÏÑ±Ìôî
      if (result.success) {
        this.overlayAutoManager.enableAutoMode()
      }
      return result
    })

    this.ipcService.registerHandler('core:stop-detection', async () => {
      const result = await this.coreService.stopGameDetection()
      // Í≤åÏûÑ Í∞êÏßÄ Ï§ëÏßÄ Ïãú ÏûêÎèô overlay Í¥ÄÎ¶¨ ÎπÑÌôúÏÑ±Ìôî
      this.overlayAutoManager.disableAutoMode()
      return result
    })

    this.ipcService.registerHandler('core:get-game-status', async () => 
      await this.coreService.getGameStatus()
    )

    this.ipcService.registerHandler('core:get-unit-counts', async (data) => 
      await this.coreService.getUnitCounts(data.playerId)
    )

    // ÌîÑÎ¶¨ÏÖã Í¥ÄÎ†® Ìï∏Îì§Îü¨
    this.ipcService.registerHandler('core:send-preset-init', async (data) => 
      await this.coreService.sendPresetInit(data)
    )

    this.ipcService.registerHandler('core:send-preset-update', async (data) => 
      await this.coreService.sendPresetUpdate(data)
    )

    console.log('üì° Core IPC Ìï∏Îì§Îü¨ Îì±Î°ù ÏôÑÎ£å')
  }

  private setupAuthHandlers(): void {
    // Ïù∏Ï¶ù Í¥ÄÎ†® Ìï∏Îì§Îü¨
    this.ipcService.registerHandler('auth:login', async (data) => 
      await this.authService.login(data.username, data.password)
    )

    this.ipcService.registerHandler('auth:logout', async () => 
      await this.authService.logout()
    )

    this.ipcService.registerHandler('auth:get-session', async () => {
      const user = await this.authService.getCurrentUser()
      return { user: user || undefined }
    })

    console.log('üì° Auth IPC Ìï∏Îì§Îü¨ Îì±Î°ù ÏôÑÎ£å')
  }

  private setupDataHandlers(): void {
    // Í∏∞Î≥∏ ÌîÑÎ¶¨ÏÖã CRUD Ìï∏Îì§Îü¨
    this.ipcService.registerHandler('data:save-preset', async (data) => 
      await this.dataService.savePreset(data.userId, data.preset)
    )

    this.ipcService.registerHandler('data:load-preset', async (data) => ({
      success: true,
      data: await this.dataService.loadPreset(data.userId, data.presetId)
    }))

    this.ipcService.registerHandler('data:get-presets', async (data) => ({
      presets: await this.dataService.loadPresets(data.userId)
    }))

    this.ipcService.registerHandler('data:delete-preset', async (data) => 
      await this.dataService.deletePreset(data.userId, data.presetId)
    )

    // ÏÉàÎ°úÏö¥ ÌîÑÎ¶¨ÏÖã Í¥ÄÎ¶¨ Ìï∏Îì§Îü¨Îì§
    this.ipcService.registerHandler('data:update-preset', async (data) => 
      await this.dataService.updatePreset(data.userId, data.presetId, data.updates)
    )

    this.ipcService.registerHandler('data:get-selected-preset', async (data) => ({
      success: true,
      data: await this.dataService.getSelectedPreset(data.userId)
    }))

    this.ipcService.registerHandler('data:set-selected-preset', async (data) => 
      await this.dataService.setSelectedPreset(data.userId, data.index)
    )

    this.ipcService.registerHandler('data:get-presets-with-selection', async (data) => ({
      success: true,
      data: await this.dataService.getPresetsWithSelection(data.userId)
    }))

    console.log('üì° Data IPC Ìï∏Îì§Îü¨ Îì±Î°ù ÏôÑÎ£å (8Í∞ú Ìï∏Îì§Îü¨)')
  }

  private setupWindowHandlers(): void {
    // ÏúàÎèÑÏö∞ Í¥ÄÎ¶¨ Ìï∏Îì§Îü¨
    this.ipcService.registerHandler('window:minimize', async () => {
      this.windowManager.minimizeMain()
    })

    this.ipcService.registerHandler('window:maximize', async () => {
      this.windowManager.maximizeMain()
    })

    this.ipcService.registerHandler('window:close', async () => {
      this.windowManager.closeMain()
    })

    this.ipcService.registerHandler('window:drag', async () => {
      // ÎìúÎûòÍ∑∏Îäî CSSÏùò -webkit-app-region: drag; Î°ú Ï≤òÎ¶¨Îê®
      // Ïù¥ Ìï∏Îì§Îü¨Îäî ÌïÑÏöîÏãú Ï∂îÍ∞Ä ÎìúÎûòÍ∑∏ Î°úÏßÅÏùÑ ÏúÑÌï¥ Î≥¥Í¥Ä
    })

    this.ipcService.registerHandler('window:toggle-overlay', async () => {
      this.windowManager.toggleOverlay()
      // Ïò§Î≤ÑÎ†àÏù¥Í∞Ä ÌëúÏãúÎêòÎäî Í≤ΩÏö∞ Ï†ÄÏû•Îêú ÏúÑÏπò Ï†ÅÏö©
      if (this.windowManager.isOverlayWindowVisible()) {
        this.overlayAutoManager.applyStoredPositionOnShow()
      }
    })

    this.ipcService.registerHandler('window:show-overlay', async () => {
      this.windowManager.showOverlay()
      // Ïò§Î≤ÑÎ†àÏù¥ ÌëúÏãú Ïãú Ï†ÄÏû•Îêú ÏúÑÏπò Ï†ÅÏö©
      this.overlayAutoManager.applyStoredPositionOnShow()
    })

    this.ipcService.registerHandler('window:hide-overlay', async () => {
      this.windowManager.hideOverlay()
    })

    this.ipcService.registerHandler('window:resize', async (data) => {
      if (data && typeof data.width === 'number' && typeof data.height === 'number') {
        this.windowManager.resizeMain(data.width, data.height)
      } else {
        console.error('‚ùå window:resize - ÏûòÎ™ªÎêú Ïù∏Ïûê:', data)
      }
    })

    this.ipcService.registerHandler('window:get-window-bounds', async () => ({
      main: this.windowManager.getMainWindowBounds(),
      overlay: this.windowManager.getOverlayWindowBounds()
    }))

    this.ipcService.registerHandler('window:set-overlay-position', async (data) => {
      this.windowManager.setOverlayPosition(data.x, data.y)
    })

    this.ipcService.registerHandler('window:set-overlay-size', async (data) => {
      this.windowManager.setOverlaySize(data.width, data.height)
    })

    this.ipcService.registerHandler('window:set-overlay-opacity', async (data) => {
      this.windowManager.setOverlayOpacity(data.opacity)
    })

    this.ipcService.registerHandler('window:toggle-dev-tools', async () => {
      this.windowManager.toggleDevTools()
    })

    // ÏúÑÏπò Ï†ÄÏû•/Î≥µÏõê Ìï∏Îì§Îü¨
    this.ipcService.registerHandler('window:save-position', async () => {
      this.windowManager.saveMainWindowPosition()
    })

    this.ipcService.registerHandler('window:restore-position', async () => {
      this.windowManager.restoreMainWindowPosition()
    })

    this.ipcService.registerHandler('window:set-position', async (data) => {
      this.windowManager.setMainWindowPosition(data.x, data.y)
    })

    console.log('üì° Window IPC Ìï∏Îì§Îü¨ Îì±Î°ù ÏôÑÎ£å')
  }

  private setupShortcutHandlers(): void {
    // Îã®Ï∂ïÌÇ§ Í¥ÄÎ¶¨ Ìï∏Îì§Îü¨
    this.ipcService.registerHandler('shortcut:register', async (data) => {
      const callback = this.getShortcutCallback(data.action)
      if (callback) {
        return { success: this.shortcutManager.registerCustomShortcut(data.accelerator, callback) }
      }
      return { success: false }
    })

    this.ipcService.registerHandler('shortcut:unregister', async (data) => {
      this.shortcutManager.unregisterShortcut(data.accelerator)
      return { success: true }
    })

    this.ipcService.registerHandler('shortcut:list', async () => ({
      shortcuts: this.shortcutManager.getRegisteredShortcuts()
    }))

    console.log('üì° Shortcut IPC Ìï∏Îì§Îü¨ Îì±Î°ù ÏôÑÎ£å')
  }

  private getShortcutCallback(action: string): (() => void) | null {
    switch (action) {
      case 'toggle-overlay':
        return () => {
          this.windowManager.toggleOverlay()
          // Ïò§Î≤ÑÎ†àÏù¥Í∞Ä ÌëúÏãúÎêòÎäî Í≤ΩÏö∞ Ï†ÄÏû•Îêú ÏúÑÏπò Ï†ÅÏö©
          if (this.windowManager.isOverlayWindowVisible()) {
            this.overlayAutoManager.applyStoredPositionOnShow()
          }
        }
      case 'show-overlay':
        return () => {
          this.windowManager.showOverlay()
          // Ïò§Î≤ÑÎ†àÏù¥ ÌëúÏãú Ïãú Ï†ÄÏû•Îêú ÏúÑÏπò Ï†ÅÏö©
          this.overlayAutoManager.applyStoredPositionOnShow()
        }
      case 'hide-overlay':
        return () => this.windowManager.hideOverlay()
      case 'toggle-dev-tools':
        return () => this.windowManager.toggleDevTools()
      case 'minimize-main':
        return () => this.windowManager.minimizeMain()
      case 'maximize-main':
        return () => this.windowManager.maximizeMain()
      case 'close-main':
        return () => this.windowManager.closeMain()
      default:
        console.warn(`‚ö†Ô∏è Ïïå Ïàò ÏóÜÎäî Îã®Ï∂ïÌÇ§ Ïï°ÏÖò: ${action}`)
        return null
    }
  }
}